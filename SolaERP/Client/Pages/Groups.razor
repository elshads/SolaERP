@page "/groups"

@using Model = Group


<PageTitle>@pageTitle</PageTitle>

<TelerikGrid @ref="@gridRef" @key="@gridKey" Data="@modelList" Height="calc(100vh - 160px)"
             Pageable="true" Sortable="true" Navigable="true" Groupable="@showGroup"
             FilterMode="@GridFilterMode.FilterMenu" ShowColumnMenu="true"
             Resizable="true" Reorderable="true" PageSize="@gridPageSize"
             SelectionMode="@(editMode ? GridSelectionMode.None : GridSelectionMode.Multiple)" SelectedItems="@selectedModelList"
             SelectedItemsChanged="@((IEnumerable<Model> itemList) => OnGridItemSelect(itemList))"
             OnRowClick="@OnRowClickHandler" OnRowDoubleClick="@OnRowDoubleClickHandler"
             ConfirmDelete="true" OnDelete="@(e => DeleteHandler(e, 1))">
    <GridToolBar>
        @if (!gridReadOnly)
        {
            <GridCommandButton Icon="add" Enabled="@(!editMode)" OnClick="CreateHandler">Add</GridCommandButton>
            <GridCommandButton Command="Delete" Icon="delete" Enabled="@(!editMode && selectedModelList.Count() > 0)" OnClick="@(e => DeleteHandler(e, 2))">Delete</GridCommandButton>
        }
        <MudSpacer />
        <GridCommandButton Command="ExportToExcel" Icon="excel">Export to Excel</GridCommandButton>
        <GridCommandButton Command="ShowRowButtons" Icon="button" OnClick="@(() => showRowButtons = !showRowButtons)">Row buttons</GridCommandButton>
        <GridCommandButton Command="ShowGroup" Icon="layout" OnClick="@(() => showGroup = !showGroup)">Group</GridCommandButton>
        <MudText Class="ml-6" Align="Align.Right">Rows per page:</MudText>
        <TelerikDropDownList Width="100px" TextField="Caption" ValueField="Size" @bind-Value="gridPageSize"
                             Data="@(new GridPageSize(modelList.Count()).GridPageSizeList)">
        </TelerikDropDownList>
    </GridToolBar>
    <GridColumns>
        <GridCommandColumn ShowColumnMenu="false" Reorderable="false" Width="90px" Visible="@(showRowButtons && !gridReadOnly)">
            <GridCommandButton Icon="edit" ShowInEdit="false" Enabled="(!editMode)" OnClick="EditHandler" />
            <GridCommandButton Command="Delete" Icon="delete" ShowInEdit="false" Enabled="(!editMode)" />
        </GridCommandColumn>
        <GridCheckboxColumn ShowColumnMenu="false" Reorderable="false" Locked="true" Width="42px" Visible="@(!editMode)" />
        <GridColumn Field="@(nameof(Model.GroupId))" Title="Id" Width="70px" Editable="false" TextAlign="ColumnTextAlign.Right" Visible="@devMode" />
        <GridColumn Field="@(nameof(Model.GroupName))" Title="Name" />
    </GridColumns>
</TelerikGrid>


@code {
    string menuCode = "usergroups";
    string pageTitle = "User Groups";
    bool gridReadOnly = false;

    bool showRowButtons { get; set; } = false;
    bool showDecimals { get; set; } = false;
    bool showGroup { get; set; } = false;

    [CascadingParameter] public AppState AppState { get; set; }
    [CascadingParameter] public DialogFactory Dialogs { get; set; }

    int activeTabIndex = 0;
    bool devMode = false;

    // Grid specific variables - start
    List<Model> modelList = new();
    IEnumerable<Model> selectedModelList = new List<Model>();
    List<Model> deletedModelList = new List<Model>();
    Model selectedModel;

    Guid gridKey;
    TelerikGrid<Model> gridRef;
    int gridPageSize = 20;
    bool editMode = false;
    // Grid specific variables - end

    // Page specific variables - start
    // Page specific variables - end


    protected override async Task OnInitializedAsync()
    {
        AppState.Loading = true;

        await FillDefaultData();
        AppStateInitialize();

        AppState.Loading = false;
    }

    async Task FillDefaultData()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

        var _businessUnitId = 0;
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("bu", out var _bu))
        {
            _businessUnitId = Convert.ToInt32(_bu);
        }

        var _modelId = 0;
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("id", out var _id))
        {
            _modelId = Convert.ToInt32(_id);
        }

        var _modelCode = "";
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("code", out var _code))
        {
            _modelCode = _code;
        }

        await FillData();
    }

    async Task FillData()
    {
        AppState.Loading = true;
        //var _modelList = await Http.GetFromJsonAsync<IEnumerable<Model>>("Model");
        var _modelList = new List<Model>();
        modelList = _modelList.ToList();
        AppState.Loading = false;
    }

    void AppStateInitialize()
    {
        // subscribe to events
    }

    void OnRowClickHandler(GridRowClickEventArgs args)
    {
        //
    }

    void OnRowDoubleClickHandler(GridRowClickEventArgs args)
    {
        var argsItem = args.Item as Model;
        NavigationManager.NavigateTo($"/groupcard?id={argsItem.GroupId}");
    }

    void SetEditMode(Model argsItem)
    {
        editMode = true;
        var currState = gridRef.GetState();
        currState.InsertedItem = null;
        currState.EditItem = null;
        currState.OriginalEditItem = null;

        Model itemToEdit = new(argsItem);

        currState.EditItem = itemToEdit;
        currState.OriginalEditItem = argsItem;
        gridRef.SetState(currState);
    }


    void OnGridItemSelect(IEnumerable<Model> itemList)
    {
        selectedModelList = itemList;
    }

    // Grid CRUD events - start

    void CreateHandler(GridCommandEventArgs args)
    {
        NavigationManager.NavigateTo("/usergroupcard");
    }

    void EditHandler(GridCommandEventArgs args)
    {
        var argsItem = (Model)args.Item;
        NavigationManager.NavigateTo($"/groupcard?id={argsItem.GroupId}");
    }

    async Task DeleteHandler(GridCommandEventArgs args, int sourceButton)
    {
        var argsItem = (Model)args?.Item;

        if (sourceButton == 1 && argsItem != null)
        {
            // Row button - has built-in confirmation dialog
            var deletedId = argsItem.GroupId;
            var response = await Http.PostAsJsonAsync<int>("Group", deletedId);
            var content = await response.Content.ReadFromJsonAsync<SqlResult>();
            if (content.DeletedResult > 0)
            {
                await FillData();
                AppState.ShowAlert($"A record with Id {deletedId} successfully deleted", Severity.Success);
            }
            else
            {
                AppState.ShowAlert(content.DeletedResultMessage, Severity.Error);
            }
        }
        else if (sourceButton == 2 && selectedModelList.Count() > 0)
        {
            // Checkbox selection
            var count = selectedModelList.Count();
            var isConfirmed = await Dialogs.ConfirmAsync($"Are you sure you want to delete {count} record(s)?", "Delete!");

            if (isConfirmed)
            {
                var response = await Http.PostAsJsonAsync<IEnumerable<int>>("Group", selectedModelList.Select(e => e.GroupId));
                var content = await response.Content.ReadFromJsonAsync<SqlResult>();
                if (content.DeletedResult > 0)
                {
                    await FillData();
                    AppState.ShowAlert($"{count} record(s) were successfully deleted", Severity.Success);
                }
                else
                {
                    AppState.ShowAlert(content.DeletedResultMessage, Severity.Error);
                }
            }
        }
        else
        {
            AppState.ShowAlert("Item is not selected", Severity.Warning);
        }
    }

    // Grid CRUD events - end

}

<style>
    .mud-checkbox .mud-icon-button {
        padding: 0;
    }
</style>